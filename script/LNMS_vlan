:global vlanst [:toarray ""]
:global vlansu [:toarray ""]

:foreach i in [/interface bridge vlan find where !disabled and !dynamic] do={
    :local intf [/interface bridge vlan get $i bridge]
    :local vlid [/interface bridge vlan get $i vlan-ids]
    :local vname

    :foreach i in [/interface vlan find where vlan-id=$vlid] do={
        :local intname [/interface vlan get $i name]
        :set $vname ($intname)
    }

    :foreach t in [/interface bridge vlan get $i tagged] do={
        :set $vlanst ($vlanst, "$vlid,$t,$vname")
    }

    :foreach u in [/interface bridge vlan get $i current-untagged] do={
        :set $vlansu ($vlansu, "$vlid,$u,$vname")
    }

    :foreach u in [/interface bridge port find where bridge=$intf and pvid=$vlid] do={
        :local iu [/interface bridge port get $u interface]
        :local fl 0
        :foreach tmp in $vlansu do={
            :local ar [:toarray $tmp]
            :if ((($ar->0) = $vlid) && (($ar->1) = $iu))  do={
                :set fl 1
            }
        }
        :if ( $fl != 1 ) do={
            :set $vlansu ($vlansu, "$vlid,$iu,$vname")
        }
    }
}

:foreach vl in [/interface vlan find ] do={
    :local intf [/interface vlan get $vl interface]
    :local vlid [/interface vlan get $vl vlan-id]
    :local vname [/interface vlan get $vl name]
    :local fl 0

    :foreach tmp in $vlanst do={
        :local ar [:toarray $tmp]
        :if ((($ar->0) = $vlid) && (($ar->1) = $intf)) do={
            :set fl 1
        }
    }
    :if ( $fl != 1 ) do={
        :set $vlanst ($vlid,$intf,$vname)
    }
}

:local noteContent "Link: $LinkAtivo\n\n### VLAN Configuration ###\n"

:set $noteContent ($noteContent . "\n# Tagged VLANs (T,VLAN-ID,Interface,VLAN-Name)\n")
:foreach tmp in $vlanst do={
    :set $noteContent ($noteContent . "T,$tmp\n")
}

:set $noteContent ($noteContent . "\n# Untagged VLANs (U,VLAN-ID,Interface,VLAN-Name)\n")
:foreach tmp in $vlansu do={
    :set $noteContent ($noteContent . "U,$tmp\n")
}

/system note set note=$noteContent

:put "System note has been updated with VLAN info."
